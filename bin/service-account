#!/bin/bash

# GCP metadata
SERVICE_NAME="query-twitter"
PROJECT=$(gcloud config get-value project)
PROJECT_NUM=$(gcloud projects describe ${PROJECT} --format="value(projectNumber)")
POLICY_MEMBER="serviceAccount:${SERVICE_NAME}-sa@${PROJECT}.iam.gserviceaccount.com"

gcloud iam service-accounts create "${SERVICE_NAME}-sa" \
    --display-name "Twitter Query Demo Service Account"

# grant service account cloud run eexcutor role
gcloud beta run services add-iam-policy-binding $SERVICE_NAME \
    --member $POLICY_MEMBER --role roles/run.invoker

# grant service account necessary roles
gcloud projects add-iam-policy-binding $PROJECT \
    --member $POLICY_MEMBER --role roles/run.invoker

gcloud projects add-iam-policy-binding $PROJECT \
    --member $POLICY_MEMBER --role roles/pubsub.editor

gcloud projects add-iam-policy-binding $PROJECT \
    --member $POLICY_MEMBER --role roles/datastore.user

gcloud projects add-iam-policy-binding $PROJECT \
	--member $POLICY_MEMBER --role roles/logging.logWriter

gcloud projects add-iam-policy-binding $PROJECT \
	--member $POLICY_MEMBER --role roles/cloudtrace.agent

